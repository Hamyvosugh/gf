<?php
global $wpdb;
use Hekmatinasser\Verta\Verta;

// Fetch all events from the wp_farakhor table without any limits
$results = $wpdb->get_results("SELECT * FROM {$wpdb->prefix}farakhor WHERE module = 'YES'");

if ($results) {
    // Get today's date in Persian (Jalali)
    $today = new Verta();
    $today->setTime(0, 0, 0); // Ensure we compare only the date part
    $currentYear = convertNumbersToPersian($today->year);

    // Fixed header for search and sort buttons
    echo '<div class="search-sort-header" style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 10px; background-color: #4c5494; position: sticky; top: 0; z-index: 100;">';

    // Search container
    echo '<div class="search-container" style="flex: 1; min-width: 200px; margin-bottom: 10px;">';
    echo '<input type="text" id="search-input" placeholder="جستجو بر اساس عنوان، توضیحات، تاریخ..." onkeyup="filterEvents()" style="width: 100%;">'; // Search Input
    echo '</div>';

    // Sort buttons container
    echo '<div class="sort-buttons-container" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">';

    // Dropdown for selecting months
    $currentPersianMonth = (new Verta())->month;
    $currentPersianMonthFormatted = sprintf("%02d", $currentPersianMonth);

    echo '<select id="month-filter" onchange="filterByMonth(this.value)" style="font-family: \'Digi Hamishe Bold\', sans-serif;">';
    echo '<option value="">انتخاب ماه</option>';
    echo '<option value="01">فروردین</option>';
    echo '<option value="02">اردیبهشت</option>';
    echo '<option value="03">خرداد</option>';
    echo '<option value="04">تیر</option>';
    echo '<option value="05">امرداد</option>';
    echo '<option value="06">شهریور</option>';
    echo '<option value="07">مهر</option>';
    echo '<option value="08">آبان</option>';
    echo '<option value="09">آذر</option>';
    echo '<option value="10">دی</option>';
    echo '<option value="11">بهمن</option>';
    echo '<option value="12">اسپند</option>';
    echo '</select>';

    // Inline script to set the current month and trigger the filtering
    echo '<script>
        document.addEventListener("DOMContentLoaded", function() {
            const monthFilter = document.getElementById("month-filter");
            if (monthFilter) {
                monthFilter.value = "' . $currentPersianMonthFormatted . '"; // Set the current Persian month
                filterByMonth("' . $currentPersianMonthFormatted . '"); // Trigger the filter on load
            }
        });
    </script>';

    // Existing buttons
    echo '<button onclick="filterByTag(\'تعطیل\')" style="padding: 5px 10px; background-color: #FF8200; color: #ffffff; border: none; cursor: pointer; border-radius: 5px; font-family: \'Digi Hamishe Regular\', sans-serif;">تعطیلات</button>';
    echo '<button onclick="filterByTag(\'جشن\')" style="padding: 5px 10px; background-color: #FF8200; color: #ffffff; border: none; cursor: pointer; border-radius: 5px; font-family: \'Digi Hamishe Regular\', sans-serif;">جشن ها</button>';
    echo '<button onclick="filterByTag(\'برنامه\')" style="padding: 5px 10px; background-color: #FF8200; color: #ffffff; border: none; cursor: pointer; border-radius: 5px; font-family: \'Digi Hamishe Regular\', sans-serif;">برنامه ها</button>';

    // Dropdown for filtering by country tags
    echo '<select id="country-selector" onchange="filterByCountry(this.value)" style="font-family: \'Digi Hamishe Bold\', sans-serif;">';
    echo '<option value="">کشور</option>';
    $countries = ['ایران', 'آلمان', 'فرانسه', 'ایتالیا', 'ژاپن'];
    foreach ($countries as $country) {
        echo '<option value="' . esc_attr($country) . '">' . $country . '</option>';
    }
    echo '</select>';

    // Dropdown for filtering by Iranian cities
    echo '<select id="city-selector" onchange="filterByCity(this.value)" style="font-family: \'Digi Hamishe Bold\', sans-serif;">';
    echo '<option value="">شهر</option>';
    $cities = ['تهران', 'اصفهان', 'مشهد', 'شیراز', 'تبریز'];
    foreach ($cities as $city) {
        echo '<option value="' . esc_attr($city) . '">' . $city . '</option>';
    }
    echo '</select>';

    // Reset filters and return to the current month buttons
    echo '<button class="refresh-button" onclick="resetToCurrentMonth()" title="بازگشت به حالت اولیه" style="background: none; border: none; cursor: pointer; display: flex; align-items: center;">';
    echo '<img src="https://hamyvosugh.com/wp-content/uploads/2024/10/refresh-square-svgrepo-com.svg" alt="refresh icon" class="refresh-icon" style="width: 50px; height: 50px;">';
    echo '</button>';

    echo '</div>'; // Close sort buttons container
    echo '</div>'; // Close search-sort-header

    // Start events container for the grid layout
    echo '<div class="farakhor-events-wrapper">';
    foreach ($results as $event) {
        // Skip any event that is not part of "YES" module
        if ($event->module !== 'YES') {
            continue;
        }

        $persianDateFormatted = convert_persian_date($event->persian_day);
        $gregorianDateFormatted = convert_gregorian_date($event->gregorian_day);

        // Check which link should be used
        $link = !empty($event->post_link) ? esc_url($event->post_link) : esc_url($event->event_link);

        // Highlight if the event is today
        $highlight = ($event->persian_day == $today->format('m-d')) ? 'today-highlight' : '';

        // Calculate the difference in days between the event date and today
        try {
            list($eventMonth, $eventDay) = explode('-', $event->persian_day);
            $eventDate = Verta::parse(sprintf("%s-%s-%s", $today->year, intval($eventMonth), intval($eventDay)));
            $daysDifference = $eventDate->diffDays($today);

            // Display the difference
            if ($eventDate->greaterThan($today)) {
                $dayStatus = convertNumbersToPersian($daysDifference) . ' روز مانده';
            } elseif ($eventDate->lessThan($today)) {
                $dayStatus = convertNumbersToPersian(abs($daysDifference)) . ' روز گذشته';
            } else {
                $dayStatus = 'امروز';
            }
        } catch (Exception $e) {
            $dayStatus = "تاریخ نامعتبر";
        }

        // Create the flip card layout
        echo '<div class="flip-card clickable-card ' . $highlight . '" data-url="' . $link . '" data-tag="' . esc_attr($event->tag) . '" data-date="' . esc_attr($event->persian_day) . '">';
        echo '  <div class="flip-card-inner">';
        echo '    <div class="flip-card-front" style="background-image: url(\'' . esc_url($event->image) . '\');">';
        echo '      <div class="overlay"></div>';
        echo '      <div class="card-title">';
        echo '        <h4 class="event-title">' . esc_html($event->event_title) . '</h4>';
        echo '      </div>';
        echo '      <div class="card-dates">';
        echo '        <p class="persian-date">' . esc_html($persianDateFormatted) . '</p>';
        echo '        <div class="bottom-info">';
        echo '          <p class="remaining-days">' . esc_html($dayStatus) . '</p>';
        echo '          <p class="gregorian-date">' . esc_html($gregorianDateFormatted) . '</p>';
        echo '        </div>';
        echo '      </div>';
        echo '    </div>';
        echo '    <div class="flip-card-back">';
        echo '      <span>' . esc_html($event->event_text) . '</span>';
        echo '      <a href="' . esc_url($link) . '" class="read-more-btn" target="_blank">بیشتر بخوانید</a>';
        echo '    </div>';
        echo '  </div>';
        echo '</div>';
    }
    echo '</div>';
} else {
    echo '<p>هیچ رویدادی پیدا نشد.</p>';
}

// Utility function to convert Persian date
function convert_persian_date($persian_day) {
    $months = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'امرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسپند'];
    list($month, $day) = explode('-', $persian_day);
    $day = convertNumbersToPersian(intval($day));
    $month = $months[intval($month) - 1];
    return "{$day} {$month}";
}

function convert_gregorian_date($gregorian_day) {
    $months = ['January' => 'ژانویه', 'February' => 'فوریه', 'March' => 'مارس', 'April' => 'آوریل', 'May' => 'مه', 'June' => 'ژوئن', 'July' => 'ژوئیه', 'August' => 'اوت', 'September' => 'سپتامبر', 'October' => 'اکتبر', 'November' => 'نوامبر', 'December' => 'دسامبر'];
    $date = new DateTime($gregorian_day);
    $day = convertNumbersToPersian($date->format('d'));
    $month = $months[$date->format('F')];
    return "{$day} {$month}";
}
?>